# 认证API文档

本文档详细介绍商城系统中与用户认证相关的所有API，包括登录、注册、获取用户信息和修改密码等操作。

### 1. 用户登录

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/auth/login`
- 权限：所有用户
- 请求体：

```json
{
  "username": "testuser",
  "password": "123456"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImlhdCI6MTYxNjc2MjIwMCwiZXhwIjoxNjE2ODQ4NjAwfQ.signature",
    "user": {
      "id": 1,
      "username": "testuser",
      "phone": "13812345678",
      "avatar": "http://example.com/avatar.jpg",
      "addresses": "[{\"id\":1,\"address\":\"北京市朝阳区xxx街道\"}]",
      "role": "ROLE_USER",
      "status": 1,
      "createTime": "2023-01-01 12:00:00",
      "updateTime": "2023-01-01 12:00:00"
    }
  }
}
```

#### 测试用例

- **用例1**：正确的用户名和密码
  - 请求：`POST http://localhost:8080/api/auth/login`
    ```json
    {
      "username": "testuser",
      "password": "password123"
    }
    ```
  - 预期结果：登录成功，返回用户信息和token

- **用例2**：错误的密码
  - 请求：`POST http://localhost:8080/api/auth/login`
    ```json
    {
      "username": "testuser",
      "password": "wrongpassword"
    }
    ```
  - 预期结果：返回401错误，提示用户名或密码错误
    ```json
    {
      "code": 401,
      "msg": "用户名或密码错误",
      "data": null
    }
    ```

- **用例3**：不存在的用户名
  - 请求：`POST http://localhost:8080/api/auth/login`
    ```json
    {
      "username": "nonexistent",
      "password": "password123"
    }
    ```
  - 预期结果：返回401错误，提示用户名或密码错误
    ```json
    {
      "code": 401,
      "msg": "用户名或密码错误",
      "data": null
    }
    ```

- **用例4**：缺少必填字段
  - 请求：`POST http://localhost:8080/api/auth/login`
    ```json
    {
      "username": "testuser"
    }
    ```
  - 预期结果：返回400错误，提示密码不能为空
    ```json
    {
      "code": 400,
      "msg": "密码不能为空",
      "data": null
    }
    ```

### 2. 用户注册

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/auth/register`
- 权限：所有用户
- 请求体：

```json
{
  "username": "newuser",
  "password": "password123",
  "phone": "13912345678"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "注册成功",
  "data": {
    "id": 2,
    "username": "newuser",
    "phone": "13912345678",
    "avatar": null,
    "addresses": null,
    "role": "ROLE_USER",
    "status": 1,
    "createTime": "2023-01-02 10:00:00",
    "updateTime": "2023-01-02 10:00:00"
  }
}
```

#### 测试用例

- **用例1**：正常注册
  - 请求：`POST http://localhost:8080/api/auth/register`
    ```json
    {
      "username": "newuser",
      "password": "password123",
      "phone": "13912345678"
    }
    ```
  - 预期结果：注册成功，返回新用户信息

- **用例2**：用户名已存在
  - 请求：`POST http://localhost:8080/api/auth/register`
    ```json
    {
      "username": "testuser",
      "password": "password123",
      "phone": "13912345678"
    }
    ```
  - 预期结果：返回400错误，提示用户名已存在
    ```json
    {
      "code": 400,
      "msg": "用户名已存在",
      "data": null
    }
    ```

- **用例3**：手机号已注册
  - 请求：`POST http://localhost:8080/api/auth/register`
    ```json
    {
      "username": "anotheruser",
      "password": "password123",
      "phone": "13812345678"
    }
    ```
  - 预期结果：返回400错误，提示手机号已注册
    ```json
    {
      "code": 400,
      "msg": "该手机号已注册",
      "data": null
    }
    ```

- **用例4**：密码长度不符合要求
  - 请求：`POST http://localhost:8080/api/auth/register`
    ```json
    {
      "username": "newuser",
      "password": "123",
      "phone": "13912345678"
    }
    ```
  - 预期结果：返回400错误，提示密码长度必须在6-20个字符之间
    ```json
    {
      "code": 400,
      "msg": "密码长度必须在6-20个字符之间",
      "data": null
    }
    ```

- **用例5**：用户名长度不符合要求
  - 请求：`POST http://localhost:8080/api/auth/register`
    ```json
    {
      "username": "new",
      "password": "password123",
      "phone": "13912345678"
    }
    ```
  - 预期结果：返回400错误，提示用户名长度必须在4-20个字符之间
    ```json
    {
      "code": 400,
      "msg": "用户名长度必须在4-20个字符之间",
      "data": null
    }
    ```

- **用例6**：手机号格式错误
  - 请求：`POST http://localhost:8080/api/auth/register`
    ```json
    {
      "username": "newuser",
      "password": "password123",
      "phone": "123456"
    }
    ```
  - 预期结果：返回400错误，提示手机号格式不正确
    ```json
    {
      "code": 400,
      "msg": "手机号格式不正确",
      "data": null
    }
    ```

### 3. 获取用户个人信息

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/users/profile`
- 权限：已认证用户
- 请求头：
  - `Authorization: Bearer {token}`

#### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": 1,
    "username": "testuser",
    "phone": "13812345678",
    "avatar": "http://example.com/avatar.jpg",
    "addresses": "[{\"id\":1,\"address\":\"北京市朝阳区xxx街道\"}]",
    "role": "ROLE_USER",
    "status": 1,
    "createTime": "2023-01-01 12:00:00",
    "updateTime": "2023-01-01 12:00:00"
  }
}
```

#### 测试用例

- **用例1**：有效token
  - 请求：`GET http://localhost:8080/api/users/profile` (带有效token)
  - 预期结果：返回用户信息

- **用例2**：无效token
  - 请求：`GET http://localhost:8080/api/users/profile` (带无效token)
  - 预期结果：返回401错误，提示未认证或token过期
    ```json
    {
      "code": 401,
      "msg": "未认证或token过期",
      "data": null
    }
    ```

- **用例3**：无token
  - 请求：`GET http://localhost:8080/api/users/profile` (不带token)
  - 预期结果：返回401错误，提示未认证
    ```json
    {
      "code": 401,
      "msg": "未认证",
      "data": null
    }
    ```

### 4. 修改用户密码

#### 请求

- 方法：`PUT`
- URL：`http://localhost:8080/api/users/password`
- 权限：已认证用户
- 请求头：
  - `Authorization: Bearer {token}`
- 请求体：

```json
{
  "oldPassword": "password123",
  "newPassword": "newpassword123"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "密码修改成功",
  "data": true
}
```

#### 测试用例

- **用例1**：正确的旧密码
  - 请求：`PUT http://localhost:8080/api/users/password` (带有效token)
    ```json
    {
      "oldPassword": "password123",
      "newPassword": "newpassword123"
    }
    ```
  - 预期结果：修改成功
    ```json
    {
      "code": 200,
      "msg": "密码修改成功",
      "data": true
    }
    ```

- **用例2**：错误的旧密码
  - 请求：`PUT http://localhost:8080/api/users/password` (带有效token)
    ```json
    {
      "oldPassword": "wrongpassword",
      "newPassword": "newpassword123"
    }
    ```
  - 预期结果：返回400错误，提示旧密码不正确
    ```json
    {
      "code": 400,
      "msg": "旧密码不正确",
      "data": null
    }
    ```

- **用例3**：新密码不符合要求
  - 请求：`PUT http://localhost:8080/api/users/password` (带有效token)
    ```json
    {
      "oldPassword": "password123",
      "newPassword": "123"
    }
    ```
  - 预期结果：返回400错误，提示密码长度必须在6-20个字符之间
    ```json
    {
      "code": 400,
      "msg": "密码长度必须在6-20个字符之间",
      "data": null
    }
    ```

### 5. 修改个人信息

#### 请求

- 方法：`PUT`
- URL：`http://localhost:8080/api/users/profile`
- 权限：已认证用户
- 请求头：
  - `Authorization: Bearer {token}`
- 请求体：

```json
{
  "username": "testuser",
  "phone": "13812345678",
  "avatar": "http://example.com/avatar.jpg",
  "addresses": "[{\"id\":1,\"address\":\"北京市朝阳区xxx街道\"}]"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "个人信息更新成功",
  "data": {
    "id": 1,
    "username": "testuser",
    "phone": "13812345678",
    "avatar": "http://example.com/avatar.jpg",
    "addresses": "[{\"id\":1,\"address\":\"北京市朝阳区xxx街道\"}]",
    "role": "ROLE_USER",
    "status": 1,
    "createTime": "2023-01-01 12:00:00",
    "updateTime": "2023-01-02 15:30:00"
  }
}
```

#### 测试用例

- **用例1**：正常更新个人信息
  - 请求：`PUT http://localhost:8080/api/users/profile` (带有效token)
    ```json
    {
      "username": "newname",
      "phone": "13912345678",
      "avatar": "http://example.com/new-avatar.jpg",
      "addresses": "[{\"id\":1,\"address\":\"新地址\"}]"
    }
    ```
  - 预期结果：更新成功，返回更新后的用户信息

- **用例2**：用户名已被使用
  - 请求：`PUT http://localhost:8080/api/users/profile` (带有效token)
    ```json
    {
      "username": "existinguser",
      "phone": "13912345678",
      "avatar": "http://example.com/avatar.jpg",
      "addresses": "[]"
    }
    ```
  - 预期结果：返回400错误，提示用户名已被使用
    ```json
    {
      "code": 400,
      "msg": "用户名已被使用",
      "data": null
    }
    ```

- **用例3**：手机号已被使用
  - 请求：`PUT http://localhost:8080/api/users/profile` (带有效token)
    ```json
    {
      "username": "testuser",
      "phone": "13800000000",
      "avatar": "http://example.com/avatar.jpg",
      "addresses": "[]"
    }
    ```
  - 预期结果：返回400错误，提示手机号已被使用
    ```json
    {
      "code": 400,
      "msg": "手机号已被使用",
      "data": null
    }
    ```

- **用例4**：用户名格式错误
  - 请求：`PUT http://localhost:8080/api/users/profile` (带有效token)
    ```json
    {
      "username": "t",
      "phone": "13912345678",
      "avatar": "http://example.com/avatar.jpg",
      "addresses": "[]"
    }
    ```
  - 预期结果：返回400错误，提示用户名长度必须在4-20个字符之间
    ```json
    {
      "code": 400,
      "msg": "用户名长度必须在4-20个字符之间",
      "data": null
    }
    ```

- **用例5**：手机号格式错误
  - 请求：`PUT http://localhost:8080/api/users/profile` (带有效token)
    ```json
    {
      "username": "testuser",
      "phone": "123456",
      "avatar": "http://example.com/avatar.jpg",
      "addresses": "[]"
    }
    ```
  - 预期结果：返回400错误，提示手机号格式不正确
    ```json
    {
      "code": 400,
      "msg": "手机号格式不正确",
      "data": null
    }
    ```

## 错误码说明

- 200: 操作成功
- 400: 请求参数错误
  - 用户名已存在
  - 手机号已注册
  - 密码长度不符合要求（6-20字符）
  - 用户名长度不符合要求（4-20字符）
  - 手机号格式不正确
  - 旧密码不正确
- 401: 未认证或token过期
  - token不存在
  - token格式错误
  - token已过期
  - 用户名或密码错误
- 403: 无权操作
  - 用户无权访问该资源
  - 用户角色权限不足
- 404: 资源不存在
  - 用户不存在
  - 请求的资源不存在
- 500: 服务器内部错误
  - 数据库操作失败
  - 系统异常

## 用户状态说明

- status = 1: 正常
- status = 0: 禁用

## 用户角色说明

- JWT令牌格式：`Bearer {token}`
- 令牌有效期：24小时(86400000毫秒)
- 认证头部名称：`Authorization`
- 令牌前缀：`Bearer`

## 测试环境

- 测试基础URL: `http://localhost:8080`
- 管理员账号: admin/123456
- 普通用户账号: user/123456