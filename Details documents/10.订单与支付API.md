# 订单API文档

本文档详细介绍商城系统中与订单相关的所有API，包括创建订单、支付、退款等操作。

## 1. 创建订单

### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/orders`
- 权限：已登录用户（需要USER角色）
- 请求体：

```json
{
  "storeId": 1,              // 必填，店铺ID
  "addressId": 1,            // 必填，收货地址ID
  "paymentType": "支付宝",    // 必填，支付方式（支付宝、微信、银行卡）
  "items": [                 // 必填，订单项列表
    {
      "productId": 1,        // 必填，商品ID
      "quantity": 2,         // 必填，购买数量
      "specInfo": "{\"颜色\":\"黑色\",\"尺寸\":\"XL\"}"  // 选填，规格信息
    }
  ],
  "remark": "请尽快发货"      // 选填，订单备注
}
```

### 响应

```json
{
  "code": 200,
  "msg": "创建订单成功",
  "data": {
    "id": 1,
    "orderNo": "202304031234567890",
    "userId": 1,
    "storeId": 1,
    "items": "[{\"productId\":1,\"productName\":\"商品名称\",\"price\":100.00,\"quantity\":2,\"specInfo\":\"{\\\"颜色\\\":\\\"黑色\\\",\\\"尺寸\\\":\\\"XL\\\"}\",\"totalPrice\":200.00}]",
    "totalAmount": 200.00,
    "addressInfo": "{\"name\":\"张三\",\"phone\":\"13800138000\",\"address\":\"详细地址\"}",
    "paymentType": "支付宝",
    "status": 0,
    "refundStatus": 0,
    "createTime": "2023-04-03T12:34:56",
    "updateTime": "2023-04-03T12:34:56"
  }
}
```

## 2. 获取订单列表

### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/orders`
- 权限：已登录用户（需要USER角色）
- 参数：无

### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "id": 1,
      "orderNo": "202304031234567890",
      "userId": 1,
      "storeId": 1,
      "items": "[{\"productId\":1,\"productName\":\"商品名称\",\"price\":100.00,\"quantity\":2,\"specInfo\":\"{\\\"颜色\\\":\\\"黑色\\\",\\\"尺寸\\\":\\\"XL\\\"}\",\"totalPrice\":200.00}]",
      "totalAmount": 200.00,
      "addressInfo": "{\"name\":\"张三\",\"phone\":\"13800138000\",\"address\":\"详细地址\"}",
      "paymentType": "ALIPAY",
      "status": 0,
      "refundStatus": 0,
      "createTime": "2023-04-03T12:34:56",
      "updateTime": "2023-04-03T12:34:56"
    }
    // 更多订单...
  ]
}
```

## 3. 分页获取订单

### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/orders/page`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `pageNum`：页码，默认为1，查询参数
  - `pageSize`：每页大小，默认为10，查询参数

### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "list": [
      {
        "id": 1,
        "orderNo": "202304031234567890",
        "userId": 1,
        "storeId": 1,
        "items": "[{\"productId\":1,\"productName\":\"商品名称\",\"price\":100.00,\"quantity\":2,\"specInfo\":\"{\\\"颜色\\\":\\\"黑色\\\",\\\"尺寸\\\":\\\"XL\\\"}\",\"totalPrice\":200.00}]",
        "totalAmount": 200.00,
        "addressInfo": "{\"name\":\"张三\",\"phone\":\"13800138000\",\"address\":\"详细地址\"}",
        "paymentType": "ALIPAY",
        "status": 0,
        "refundStatus": 0,
        "createTime": "2023-04-03T12:34:56",
        "updateTime": "2023-04-03T12:34:56"
      }
      // 更多订单...
    ],
    "pageNum": 1,
    "pageSize": 10
  }
}
```

## 4. 获取订单详情

### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/orders/{id}`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `id`：订单ID，路径参数

### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": 1,
    "orderNo": "202304031234567890",
    "userId": 1,
    "storeId": 1,
    "items": "[{\"productId\":1,\"productName\":\"商品名称\",\"price\":100.00,\"quantity\":2,\"specInfo\":\"{\\\"颜色\\\":\\\"黑色\\\",\\\"尺寸\\\":\\\"XL\\\"}\",\"totalPrice\":200.00}]",
    "totalAmount": 200.00,
    "addressInfo": "{\"name\":\"张三\",\"phone\":\"13800138000\",\"address\":\"详细地址\"}",
    "paymentType": "ALIPAY",
    "status": 0,
    "refundStatus": 0,
    "createTime": "2023-04-03T12:34:56",
    "updateTime": "2023-04-03T12:34:56"
  }
}
```

## 5. 按状态查询订单

### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/orders/status/{status}`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `status`：订单状态，路径参数（0-待付款，1-待发货，2-待收货，3-已完成，4-已取消）

### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "id": 1,
      "orderNo": "202304031234567890",
      "userId": 1,
      "storeId": 1,
      "items": "[{\"productId\":1,\"productName\":\"商品名称\",\"price\":100.00,\"quantity\":2,\"specInfo\":\"{\\\"颜色\\\":\\\"黑色\\\",\\\"尺寸\\\":\\\"XL\\\"}\",\"totalPrice\":200.00}]",
      "totalAmount": 200.00,
      "addressInfo": "{\"name\":\"张三\",\"phone\":\"13800138000\",\"address\":\"详细地址\"}",
      "paymentType": "ALIPAY",
      "status": 0,
      "refundStatus": 0,
      "createTime": "2023-04-03T12:34:56",
      "updateTime": "2023-04-03T12:34:56"
    }
    // 更多订单...
  ]
}
```

## 6. 取消订单

### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/orders/{id}/cancel`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `id`：订单ID，路径参数

### 响应

```json
{
  "code": 200,
  "msg": "取消订单成功",
  "data": true
}
```

## 7. 支付订单

### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/payment/pay`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `orderId`：订单ID，查询参数
  - `paymentType`：支付方式，查询参数（支付宝、微信、银行卡）

### 响应

```json
{
  "code": 200,
  "msg": "支付成功",
  "data": {
    "success": true,
    "message": "支付成功",
    "orderId": 1,
    "amount": 200.00,
    "paymentType": "支付宝"
  }
}
```

## 8. 商家发货

### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/orders/{id}/ship`
- 权限：商家（需要MERCHANT角色）
- 参数：
  - `id`：订单ID，路径参数

### 响应

```json
{
  "code": 200,
  "msg": "发货成功",
  "data": true
}
```

## 9. 确认收货

### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/orders/{id}/receive`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `id`：订单ID，路径参数

### 响应

```json
{
  "code": 200,
  "msg": "确认收货成功",
  "data": true
}
```

## 10. 申请退款

### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/payment/refund`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `orderId`：订单ID，查询参数
  - `reason`：退款原因，查询参数

### 响应

```json
{
  "code": 200,
  "msg": "退款申请提交成功",
  "data": true
}
```

## 11. 处理退款申请

### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/payment/refund/handle`
- 权限：商家或管理员（需要MERCHANT或ADMIN角色）
- 参数：
  - `orderId`：订单ID，查询参数
  - `isAgree`：是否同意退款，查询参数

### 响应

```json
{
  "code": 200,
  "msg": "退款已处理",
  "data": true
}
```

## 12. 获取订单状态统计

### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/orders/count`
- 权限：已登录用户（需要USER角色）

### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "pendingPayment": 1,    // 待付款
    "pendingShipment": 2,   // 待发货
    "pendingReceipt": 1,    // 待收货
    "completed": 5,         // 已完成
    "pendingReview": 2      // 待评价
  }
}
```

## 13. 获取支付方式列表

### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/payment/methods`
- 权限：已登录用户（需要USER角色）

### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "支付宝": "支付宝",
    "微信": "微信支付",
    "银行卡": "信用卡"
  }
}
```

## 订单状态说明

- 0: 待付款（UNPAID）
- 1: 待发货（PAID）
- 2: 待收货（SHIPPED）
- 3: 已完成（COMPLETED）
- 4: 已取消（CANCELLED）
- 5: 已退款（REFUNDED）
- 6: 退款申请中（REFUND_PENDING）
- 7: 退款被拒绝（REFUND_REJECTED）
- 8: 待评价（PENDING_REVIEW）

## 支付方式说明

- 支付宝（ALIPAY）
- 微信（WECHAT）
- 银行卡（CREDIT_CARD）

## 订单状态流转规则

1. 待付款 -> 已取消/待发货
2. 待发货 -> 待收货/退款申请中
3. 待收货 -> 已完成/退款申请中
4. 已完成 -> 待评价
5. 退款申请中 -> 已退款/退款被拒绝

## 库存处理规则

1. 创建订单时：
   - 系统会自动检查商品库存
   - 如果库存充足，会减少相应数量的库存
   - 如果库存不足，订单创建失败

2. 取消订单时：
   - 系统会自动恢复商品库存
   - 恢复数量等于订单中的购买数量

3. 退款成功时：
   - 系统会自动恢复商品库存
   - 恢复数量等于退款商品的数量

## 错误码说明

- 200: 操作成功
- 400: 请求参数错误
- 401: 未认证或token过期
- 403: 无权操作
- 404: 资源不存在
- 500: 服务器内部错误

## 注意事项

1. 所有需要认证的接口都需要在请求头中携带token
2. 订单状态的流转必须遵循以下规则：
   - 待付款 -> 已取消/待发货
   - 待发货 -> 待收货/退款申请中
   - 待收货 -> 已完成/退款申请中
   - 退款申请中 -> 已退款/退款被拒绝
3. 商品库存会在以下情况发生变化：
   - 创建订单时：减少库存
   - 取消订单时：恢复库存
   - 退款成功时：恢复库存
4. 支付方式必须使用系统支持的类型（ALIPAY、WECHAT、CREDIT_CARD）
5. 所有金额相关的字段使用BigDecimal类型，保留两位小数
6. 订单创建后会自动清空购物车中已购买的商品
7. 订单完成后会自动进入待评价状态

## 测试用例

### 创建订单
- **用例1**：正常创建订单
  - 请求：`POST http://localhost:8080/api/orders`
    ```json
    {
      "storeId": 1,
      "addressId": 1,
      "paymentType": "支付宝",
      "items": [
        {
          "productId": 1,
          "quantity": 2
        }
      ]
    }
    ```
  - 预期结果：创建成功，返回订单信息

- **用例2**：创建订单（商品库存不足）
  - 请求：同上，但商品库存不足
  - 预期结果：返回库存不足错误

### 支付订单
- **用例1**：正常支付订单
  - 请求：`POST http://localhost:8080/api/payment/pay?orderId=1&paymentType=支付宝`
  - 预期结果：支付成功，返回支付结果

- **用例2**：支付不存在的订单
  - 请求：`POST http://localhost:8080/api/payment/pay?orderId=999&paymentType=支付宝`
  - 预期结果：返回订单不存在错误

### 申请退款
- **用例1**：申请退款（待发货状态）
  - 请求：`POST http://localhost:8080/api/payment/refund?orderId=1&reason=商品质量问题`
  - 预期结果：退款申请提交成功

- **用例2**：申请退款（订单状态不允许）
  - 请求：`POST http://localhost:8080/api/payment/refund?orderId=1&reason=商品质量问题`
  - 预期结果：返回订单状态错误信息

### 商家发货
- **用例1**：正常发货
  - 请求：`POST http://localhost:8080/api/orders/1/ship`
  - 预期结果：发货成功

- **用例2**：发货（订单状态错误）
  - 请求：`POST http://localhost:8080/api/orders/1/ship`
  - 预期结果：返回订单状态错误信息

## 测试环境

- 测试基础URL: `http://localhost:8080`
- 普通用户账号: user/password
- 商家账号: merchant/password
- 管理员账号: admin/password