# 支付API文档

本文档详细介绍商城系统中与支付相关的所有API，包括支付、退款等操作。

### 1. 支付订单

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/payment/pay`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `orderId`：订单ID，必填，查询参数
  - `paymentType`：支付方式，必填，查询参数（ALIPAY-支付宝、WECHAT-微信支付、CREDIT_CARD-信用卡）

#### 响应

```json
{
  "code": 200,
  "msg": "支付成功",
  "data": {
    "success": true,
    "message": "支付成功",
    "orderId": 1,
    "amount": 5999.00,
    "paymentType": "ALIPAY"
  }
}
```

#### 测试用例

- **用例1**：使用支付宝支付
  - 请求：`POST http://localhost:8080/api/payment/pay?orderId=1&paymentType=ALIPAY`
  - 预期结果：支付成功，返回支付结果信息

- **用例2**：使用微信支付
  - 请求：`POST http://localhost:8080/api/payment/pay?orderId=1&paymentType=WECHAT`
  - 预期结果：支付成功，返回支付结果信息

- **用例3**：使用信用卡支付
  - 请求：`POST http://localhost:8080/api/payment/pay?orderId=1&paymentType=CREDIT_CARD`
  - 预期结果：支付成功，返回支付结果信息

- **用例4**：支付不存在的订单
  - 请求：`POST http://localhost:8080/api/payment/pay?orderId=999&paymentType=ALIPAY`
  - 预期结果：返回错误信息，提示订单不存在

- **用例5**：使用不支持的支付方式
  - 请求：`POST http://localhost:8080/api/payment/pay?orderId=1&paymentType=INVALID`
  - 预期结果：返回错误信息，提示不支持的支付方式

### 2. 申请退款

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/payment/refund`
- 权限：已登录用户（需要USER角色）
- 参数：
  - `orderId`：订单ID，必填，查询参数
  - `reason`：退款原因，必填，查询参数

#### 响应

```json
{
  "code": 200,
  "msg": "退款申请提交成功",
  "data": true
}
```

#### 测试用例

- **用例1**：申请已支付订单退款
  - 请求：`POST http://localhost:8080/api/payment/refund?orderId=1&reason=商品质量问题`
  - 预期结果：退款申请提交成功

- **用例2**：申请已发货订单退款
  - 请求：`POST http://localhost:8080/api/payment/refund?orderId=2&reason=收到商品损坏`
  - 预期结果：退款申请提交成功

- **用例3**：申请未支付订单退款
  - 请求：`POST http://localhost:8080/api/payment/refund?orderId=3&reason=不想买了`
  - 预期结果：返回错误信息，提示订单状态不允许申请退款

- **用例4**：申请已完成订单退款
  - 请求：`POST http://localhost:8080/api/payment/refund?orderId=4&reason=商品不合适`
  - 预期结果：返回错误信息，提示订单状态不允许申请退款

### 3. 处理退款申请

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/payment/refund/handle`
- 权限：商家或管理员（需要MERCHANT或ADMIN角色）
- 参数：
  - `orderId`：订单ID，必填，查询参数
  - `isAgree`：是否同意退款，必填，查询参数（true-同意，false-拒绝）

#### 响应

```json
{
  "code": 200,
  "msg": "退款已处理",
  "data": true
}
```

#### 测试用例

- **用例1**：商家同意退款
  - 请求：`POST http://localhost:8080/api/payment/refund/handle?orderId=1&isAgree=true`
  - 预期结果：退款处理成功，订单状态更新为已退款

- **用例2**：商家拒绝退款
  - 请求：`POST http://localhost:8080/api/payment/refund/handle?orderId=1&isAgree=false`
  - 预期结果：退款处理成功，订单状态更新为退款被拒绝

- **用例3**：处理不存在的订单退款
  - 请求：`POST http://localhost:8080/api/payment/refund/handle?orderId=999&isAgree=true`
  - 预期结果：返回错误信息，提示订单不存在

- **用例4**：处理非退款申请中的订单
  - 请求：`POST http://localhost:8080/api/payment/refund/handle?orderId=2&isAgree=true`
  - 预期结果：返回错误信息，提示订单状态不正确

### 4. 获取支付方式列表

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/payment/methods`
- 权限：已登录用户（需要USER角色）

#### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "ALIPAY": "支付宝",
    "WECHAT": "微信支付",
    "CREDIT_CARD": "信用卡"
  }
}
```

#### 测试用例

- **用例1**：获取支付方式列表
  - 请求：`GET http://localhost:8080/api/payment/methods`
  - 预期结果：返回所有支持的支付方式列表

## 订单状态说明

- 0: 待付款（UNPAID）
- 1: 已支付（PAID）
- 2: 已发货（SHIPPED）
- 3: 已完成（COMPLETED）
- 4: 已取消（CANCELLED）
- 5: 已退款（REFUNDED）
- 6: 退款申请中（REFUND_PENDING）
- 7: 退款被拒绝（REFUND_REJECTED）

## 错误码说明

- 200: 操作成功
- 400: 请求参数错误
- 401: 未认证或token过期
- 403: 无权操作
- 404: 资源不存在
- 500: 服务器内部错误

## 注意事项

1. 所有需要认证的接口都需要在请求头中携带token
2. 订单状态的流转必须遵循以下规则：
   - 待付款 -> 已取消/已支付
   - 已支付 -> 已发货/退款申请中
   - 已发货 -> 已完成/退款申请中
   - 退款申请中 -> 已退款/退款被拒绝
3. 商品库存会在以下情况发生变化：
   - 创建订单时：减少库存
   - 取消订单时：恢复库存
   - 退款成功时：恢复库存
4. 支付方式必须使用系统支持的类型（ALIPAY、WECHAT、CREDIT_CARD）
5. 所有金额相关的字段使用BigDecimal类型，保留两位小数

## 测试环境

- 测试基础URL: `http://localhost:8080/api/payment`
- 商家账号: merchant/password
- 管理员账号: admin/password
- 普通用户账号: user/password 