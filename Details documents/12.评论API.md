# 评论API文档

本文档详细介绍商城系统中与评论相关的所有API，包括发布、查询、回复、审核等操作。

### 1. 发布评论

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/reviews`
- 权限：普通用户
- 请求体：

```json
{
    "productId": 1,        // 必填，商品ID
    "orderId": 1,         // 必填，订单ID
    "content": "商品很好", // 必填，评论内容
    "rating": 5,          // 必填，评分(1-5星)
    "images": [           // 选填，评论图片
        "image1.jpg",
        "image2.jpg"
    ],
    "type": 0            // 必填，评论类型(0-用户评论)
}
```

#### 响应

```json
{
    "code": 200,
    "msg": "评论发布成功",
    "data": {
        "id": 1,
        "productId": 1,
        "userId": 1,
        "orderId": 1,
        "content": "商品很好",
        "rating": 5,
        "images": "[\"image1.jpg\",\"image2.jpg\"]",
        "parentId": null,
        "type": 0,
        "status": 0,
        "isTop": false,
        "reason": null,
        "createTime": "2024-04-03T12:00:00",
        "updateTime": "2024-04-03T12:00:00"
    }
}
```

#### 测试用例

- **用例1**：用户发布评论
  - 请求：`POST http://localhost:8080/api/reviews`（使用用户token）
    ```json
    {
        "productId": 1,
        "orderId": 1,
        "content": "商品质量非常好，物流很快！",
        "rating": 5,
        "images": ["image1.jpg", "image2.jpg"]
    }
    ```
  - 预期结果：评论发布成功，返回评论信息

- **用例2**：发布评论缺少必要信息
  - 请求：`POST http://localhost:8080/api/reviews`（使用用户token）
    ```json
    {
        "productId": 1,
        "content": "好评"
    }
    ```
  - 预期结果：返回错误信息，提示缺少必要字段

### 2. 回复评论

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/reviews/reply`
- 权限：已登录用户（用户或商家）
- 请求体：

```json
{
    "parentId": 1,        // 必填，父评论ID
    "content": "感谢您的购买与支持", // 必填，回复内容
    "images": [           // 选填，回复图片
        "image1.jpg"
    ],
    "type": 1            // 必填，评论类型(1-商家回复, 2-用户追评)
}
```

#### 响应

```json
{
    "code": 200,
    "msg": "回复成功",
    "data": {
        "id": 2,
        "productId": 1,
        "userId": 2,
        "orderId": 1,
        "content": "感谢您的购买与支持",
        "rating": 0,
        "images": "[\"image1.jpg\"]",
        "parentId": 1,
        "type": 1,
        "status": 0,
        "isTop": false,
        "reason": null,
        "createTime": "2024-04-03T13:00:00",
        "updateTime": "2024-04-03T13:00:00"
    }
}
```

### 3. 获取评论回复列表

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/reviews/{parentId}/replies`
- 权限：所有用户
- 参数：
  - `parentId`：父评论ID，路径参数

#### 响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": [
        {
            "id": 2,
            "productId": 1,
            "userId": 2,
            "orderId": 1,
            "content": "感谢您的购买与支持",
            "rating": 0,
            "images": "[\"image1.jpg\"]",
            "parentId": 1,
            "type": 1,
            "status": 0,
            "isTop": false,
            "reason": null,
            "createTime": "2024-04-03T13:00:00",
            "updateTime": "2024-04-03T13:00:00"
        }
    ]
}
```

### 4. 获取商品评论列表

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/reviews/product/{productId}`
- 权限：所有用户
- 参数：
  - `productId`：商品ID，路径参数

#### 响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": [
        {
            "id": 1,
            "productId": 1,
            "userId": 1,
            "orderId": 1,
            "content": "商品很好",
            "rating": 5,
            "images": "[\"image1.jpg\",\"image2.jpg\"]",
            "parentId": null,
            "type": 0,
            "status": 0,
            "isTop": true,
            "reason": null,
            "createTime": "2024-04-03T12:00:00",
            "updateTime": "2024-04-03T13:00:00"
        }
    ]
}
```

注意：
- 普通用户只能看到状态为0（正常显示）的评论
- 商家可以看到与自己商品相关的所有评论
- 管理员可以看到所有评论

### 5. 商家提交评论审核

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/reviews/{id}/review-request`
- 权限：商家
- 参数：
  - `id`：评论ID，路径参数
  - `reason`：申请审核的理由，查询参数

#### 响应

```json
{
    "code": 200,
    "msg": "提交审核成功",
    "data": {
        "id": 1,
        "status": 1,
        "reason": "这条评论可能违反社区规范",
        // ... 其他字段
    }
}
```

### 6. 管理员审核评论

#### 请求

- 方法：`PUT`
- URL：`http://localhost:8080/api/reviews/{id}/audit`
- 权限：管理员
- 参数：
  - `id`：评论ID，路径参数
  - `status`：状态(1-显示, 2-隐藏)，查询参数

#### 响应

```json
{
    "code": 200,
    "msg": "审核成功",
    "data": true
}
```

### 7. 商家设置评论置顶

#### 请求

- 方法：`PUT`
- URL：`http://localhost:8080/api/reviews/{id}/top`
- 权限：商家
- 参数：
  - `id`：评论ID，路径参数
  - `isTop`：是否置顶，查询参数

#### 响应

```json
{
    "code": 200,
    "msg": "评论已置顶",
    "data": true
}
```

### 8. 删除评论

#### 请求

- 方法：`DELETE`
- URL：`http://localhost:8080/api/reviews/{id}`
- 权限：管理员
- 参数：
  - `id`：评论ID，路径参数

#### 响应

```json
{
    "code": 200,
    "msg": "评论删除成功",
    "data": true
}
```

### 9. 获取待审核评论列表

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/reviews/pending`
- 权限：管理员

#### 响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": [
        {
            "id": 1,
            "productId": 1,
            "userId": 1,
            "orderId": 1,
            "content": "商品很好",
            "rating": 5,
            "images": "[\"image1.jpg\",\"image2.jpg\"]",
            "parentId": null,
            "type": 0,
            "status": 1,
            "isTop": false,
            "reason": "这条评论可能违反社区规范",
            "createTime": "2024-04-03T12:00:00",
            "updateTime": "2024-04-03T12:00:00"
        }
    ]
}
```

### 10. 获取商品评论统计

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/reviews/product/{productId}/stats`
- 权限：所有用户
- 参数：
  - `productId`：商品ID，路径参数

#### 响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "count": 10,           // 评论总数（只统计状态为0的评论）
        "averageRating": 4.5   // 平均评分（只统计状态为0且type为0的评论）
    }
}
```

## 状态码说明

### 评论状态（status）
- 0: 正常显示
- 1: 待审核
- 2: 隐藏

### 评论类型（type）
- 0: 用户评论（有评分）
- 1: 商家回复（评分为0）
- 2: 用户追评（评分为0）

### HTTP状态码
- 200: 操作成功
- 400: 请求参数错误
- 401: 未认证或token过期
- 403: 无权操作
- 404: 资源不存在
- 500: 服务器内部错误

## 测试环境

- 测试基础URL: `http://localhost:8080/api/reviews`
- 管理员账号: admin/password
- 商家账号: merchant/password
- 普通用户账号: user/password 