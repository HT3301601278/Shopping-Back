# 客服API文档

本文档详细介绍商城系统中与客服相关的所有API，包括会话管理、消息发送、评价和投诉处理等操作。

### 1. 创建客服会话

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/customer-service/sessions`
- 权限：普通用户
- 请求体：

```json
{
  "storeId": 1
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "会话创建成功",
  "data": {
    "id": 1,
    "userId": 10,
    "storeId": 1,
    "status": 0,
    "startTime": "2023-10-01T10:00:00",
    "createTime": "2023-10-01T10:00:00",
    "updateTime": "2023-10-01T10:00:00"
  }
}
```

#### 测试用例

- **用例1**：用户成功创建会话
  - 请求：`POST /api/customer-service/sessions`
    ```json
    {
      "storeId": 1
    }
    ```
  - 预期结果：会话创建成功，返回会话信息

- **用例2**：用户已有活跃会话再次创建
  - 请求：`POST /api/customer-service/sessions`
    ```json
    {
      "storeId": 1
    }
    ```
  - 预期结果：返回已存在的活跃会话

- **用例3**：非用户角色创建会话
  - 请求：`POST /api/customer-service/sessions`（使用商家token）
    ```json
    {
      "storeId": 1
    }
    ```
  - 预期结果：返回403错误，提示无权限

### 2. 获取用户的会话列表

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/customer-service/sessions/user`
- 权限：普通用户

#### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "id": 1,
      "storeId": 1,
      "storeName": "电子产品商店",
      "status": 0,
      "startTime": "2023-10-01T10:00:00",
      "endTime": null,
      "lastMessage": "您好，有什么可以帮到您？",
      "unreadCount": 1
    },
    {
      "id": 2,
      "storeId": 2,
      "storeName": "服装专卖店",
      "status": 1,
      "startTime": "2023-09-28T14:30:00",
      "endTime": "2023-09-28T15:00:00",
      "lastMessage": "谢谢您的咨询，再见！",
      "unreadCount": 0
    }
  ]
}
```

#### 测试用例

- **用例1**：用户查看自己的会话列表
  - 请求：`GET /api/customer-service/sessions/user`
  - 预期结果：返回用户的所有会话列表

- **用例2**：用户没有会话记录
  - 请求：`GET /api/customer-service/sessions/user`（使用新注册用户token）
  - 预期结果：返回空数组

- **用例3**：非用户角色查看会话列表
  - 请求：`GET /api/customer-service/sessions/user`（使用商家token）
  - 预期结果：返回403错误，提示无权限

### 3. 获取店铺的会话列表

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/customer-service/sessions/store/{storeId}`
- 权限：商家用户
- 参数：
  - `storeId`：店铺ID，路径参数

#### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "id": 1,
      "userId": 10,
      "userName": "张三",
      "status": 0,
      "startTime": "2023-10-01T10:00:00",
      "endTime": null,
      "lastMessage": "您好，请问这个商品什么时候发货？",
      "unreadCount": 1
    },
    {
      "id": 3,
      "userId": 12,
      "userName": "李四",
      "status": 1,
      "startTime": "2023-09-30T09:15:00",
      "endTime": "2023-09-30T09:45:00",
      "lastMessage": "好的，我知道了，谢谢！",
      "unreadCount": 0
    }
  ]
}
```

#### 测试用例

- **用例1**：商家查看自己店铺的会话列表
  - 请求：`GET /api/customer-service/sessions/store/1`
  - 预期结果：返回店铺ID为1的所有会话列表

- **用例2**：查看不属于该商家的店铺会话
  - 请求：`GET /api/customer-service/sessions/store/2`（使用店铺1的商家token）
  - 预期结果：返回403错误，提示无权限

- **用例3**：非商家角色查看店铺会话
  - 请求：`GET /api/customer-service/sessions/store/1`（使用普通用户token）
  - 预期结果：返回403错误，提示无权限

### 4. 结束会话

#### 请求

- 方法：`PUT`
- URL：`http://localhost:8080/api/customer-service/sessions/{sessionId}/end`
- 权限：会话相关用户（用户或商家）
- 参数：
  - `sessionId`：会话ID，路径参数

#### 响应

```json
{
  "code": 200,
  "msg": "会话已结束",
  "data": true
}
```

#### 测试用例

- **用例1**：用户结束自己的会话
  - 请求：`PUT /api/customer-service/sessions/1/end`（使用会话相关用户token）
  - 预期结果：会话结束成功，返回true

- **用例2**：商家结束店铺的会话
  - 请求：`PUT /api/customer-service/sessions/1/end`（使用会话相关商家token）
  - 预期结果：会话结束成功，返回true

- **用例3**：结束已结束的会话
  - 请求：`PUT /api/customer-service/sessions/2/end`（假设会话2已结束）
  - 预期结果：返回错误信息，提示会话已结束

- **用例4**：结束不属于自己的会话
  - 请求：`PUT /api/customer-service/sessions/3/end`（使用与会话无关的用户token）
  - 预期结果：返回403错误，提示无权限

### 5. 获取会话消息

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/customer-service/messages/{sessionId}`
- 权限：会话相关用户（用户或商家）
- 参数：
  - `sessionId`：会话ID，路径参数

#### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "id": 1,
      "sessionId": 1,
      "userId": 10,
      "storeId": 1,
      "fromType": 0,
      "content": "您好，请问这个商品什么时候发货？",
      "contentType": "text",
      "readStatus": true,
      "createTime": "2023-10-01T10:00:30"
    },
    {
      "id": 2,
      "sessionId": 1,
      "userId": 10,
      "storeId": 1,
      "fromType": 1,
      "content": "您好，该商品预计3天内发货，请耐心等待。",
      "contentType": "text",
      "readStatus": false,
      "createTime": "2023-10-01T10:01:15"
    }
  ]
}
```

#### 测试用例

- **用例1**：用户查看自己会话的消息
  - 请求：`GET /api/customer-service/messages/1`（使用会话相关用户token）
  - 预期结果：返回会话ID为1的所有消息

- **用例2**：商家查看店铺会话的消息
  - 请求：`GET /api/customer-service/messages/1`（使用会话相关商家token）
  - 预期结果：返回会话ID为1的所有消息

- **用例3**：查看不存在的会话消息
  - 请求：`GET /api/customer-service/messages/999`
  - 预期结果：返回错误信息，提示会话不存在

- **用例4**：查看不属于自己的会话消息
  - 请求：`GET /api/customer-service/messages/3`（使用与会话无关的用户token）
  - 预期结果：返回403错误，提示无权限

### 6. 发送消息（用户）

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/customer-service/messages/{sessionId}/user`
- 权限：普通用户
- 参数：
  - `sessionId`：会话ID，路径参数
- 请求体：

```json
{
  "sessionId": 1,
  "content": "我想了解一下退货政策",
  "contentType": "text"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "消息发送成功",
  "data": {
    "id": 3,
    "sessionId": 1,
    "userId": 10,
    "storeId": 1,
    "fromType": 0,
    "content": "我想了解一下退货政策",
    "contentType": "text",
    "readStatus": false,
    "createTime": "2023-10-01T10:05:20"
  }
}
```

#### 测试用例

- **用例1**：用户发送文本消息
  - 请求：`POST /api/customer-service/messages/1/user`
    ```json
    {
      "sessionId": 1,
      "content": "我想了解一下退货政策",
      "contentType": "text"
    }
    ```
  - 预期结果：消息发送成功，返回消息信息

- **用例2**：用户发送图片消息
  - 请求：`POST /api/customer-service/messages/1/user`
    ```json
    {
      "sessionId": 1,
      "content": "http://example.com/image.jpg",
      "contentType": "image"
    }
    ```
  - 预期结果：消息发送成功，返回消息信息

- **用例3**：发送消息到已结束的会话
  - 请求：`POST /api/customer-service/messages/2/user`（假设会话2已结束）
    ```json
    {
      "sessionId": 2,
      "content": "测试消息",
      "contentType": "text"
    }
    ```
  - 预期结果：发送失败，返回错误信息（会话已结束）

- **用例4**：非用户发送消息
  - 请求：`POST /api/customer-service/messages/1/user`（使用商家token）
    ```json
    {
      "sessionId": 1,
      "content": "测试消息",
      "contentType": "text"
    }
    ```
  - 预期结果：返回403错误，提示无权限

### 7. 发送消息（商家）

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/customer-service/messages/{sessionId}/merchant`
- 权限：商家用户
- 参数：
  - `sessionId`：会话ID，路径参数
- 请求体：

```json
{
  "sessionId": 1,
  "content": "我们的退货政策是：收到商品7天内可无理由退货",
  "contentType": "text"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "消息发送成功",
  "data": {
    "id": 4,
    "sessionId": 1,
    "userId": 10,
    "storeId": 1,
    "fromType": 1,
    "content": "我们的退货政策是：收到商品7天内可无理由退货",
    "contentType": "text",
    "readStatus": false,
    "createTime": "2023-10-01T10:06:30"
  }
}
```

#### 测试用例

- **用例1**：商家发送文本消息
  - 请求：`POST /api/customer-service/messages/1/merchant`
    ```json
    {
      "sessionId": 1,
      "content": "我们的退货政策是：收到商品7天内可无理由退货",
      "contentType": "text"
    }
    ```
  - 预期结果：消息发送成功，返回消息信息

- **用例2**：非该店铺商家发送消息
  - 请求：`POST /api/customer-service/messages/1/merchant`（使用不相关店铺商家token）
    ```json
    {
      "sessionId": 1,
      "content": "测试消息",
      "contentType": "text"
    }
    ```
  - 预期结果：返回403错误，提示无权限

- **用例3**：非商家角色发送消息
  - 请求：`POST /api/customer-service/messages/1/merchant`（使用普通用户token）
    ```json
    {
      "sessionId": 1,
      "content": "测试消息",
      "contentType": "text"
    }
    ```
  - 预期结果：返回403错误，提示无权限

### 8. 标记消息已读（用户）

#### 请求

- 方法：`PUT`
- URL：`http://localhost:8080/api/customer-service/messages/{sessionId}/read/user`
- 权限：普通用户
- 参数：
  - `sessionId`：会话ID，路径参数

#### 响应

```json
{
  "code": 200,
  "msg": "消息已标记为已读",
  "data": true
}
```

#### 测试用例

- **用例1**：用户标记商家消息为已读
  - 请求：`PUT /api/customer-service/messages/1/read/user`
  - 预期结果：标记成功，返回true

- **用例2**：标记不存在的会话消息
  - 请求：`PUT /api/customer-service/messages/999/read/user`
  - 预期结果：返回错误信息，提示会话不存在

- **用例3**：非用户角色标记消息
  - 请求：`PUT /api/customer-service/messages/1/read/user`（使用商家token）
  - 预期结果：返回403错误，提示无权限

### 9. 标记消息已读（商家）

#### 请求

- 方法：`PUT`
- URL：`http://localhost:8080/api/customer-service/messages/{sessionId}/read/merchant`
- 权限：商家用户
- 参数：
  - `sessionId`：会话ID，路径参数

#### 响应

```json
{
  "code": 200,
  "msg": "消息已标记为已读",
  "data": true
}
```

#### 测试用例

- **用例1**：商家标记用户消息为已读
  - 请求：`PUT /api/customer-service/messages/1/read/merchant`
  - 预期结果：标记成功，返回true

- **用例2**：非相关店铺商家标记消息
  - 请求：`PUT /api/customer-service/messages/1/read/merchant`（使用不相关店铺商家token）
  - 预期结果：返回403错误，提示无权限

- **用例3**：非商家角色标记消息
  - 请求：`PUT /api/customer-service/messages/1/read/merchant`（使用普通用户token）
  - 预期结果：返回403错误，提示无权限

### 10. 评价会话

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/customer-service/sessions/{sessionId}/evaluate`
- 权限：普通用户
- 参数：
  - `sessionId`：会话ID，路径参数
- 请求体：

```json
{
  "evaluation": 5,
  "remark": "服务态度非常好，问题解决得很及时"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "评价成功",
  "data": true
}
```

#### 测试用例

- **用例1**：用户评价已结束的会话
  - 请求：`POST /api/customer-service/sessions/2/evaluate`（假设会话2已结束）
    ```json
    {
      "evaluation": 5,
      "remark": "服务态度非常好，问题解决得很及时"
    }
    ```
  - 预期结果：评价成功，返回true

- **用例2**：用户评价进行中的会话
  - 请求：`POST /api/customer-service/sessions/1/evaluate`（假设会话1进行中）
    ```json
    {
      "evaluation": 4,
      "remark": "服务态度不错"
    }
    ```
  - 预期结果：返回错误信息，提示会话未结束，不能评价

- **用例3**：评价不属于自己的会话
  - 请求：`POST /api/customer-service/sessions/3/evaluate`（假设会话3不属于当前用户）
    ```json
    {
      "evaluation": 3,
      "remark": "一般"
    }
    ```
  - 预期结果：返回403错误，提示无权限

- **用例4**：评价分数超出范围
  - 请求：`POST /api/customer-service/sessions/2/evaluate`
    ```json
    {
      "evaluation": 6,
      "remark": "非常好"
    }
    ```
  - 预期结果：返回400错误，提示评分必须在1-5之间

### 11. 获取店铺的客服满意度

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/customer-service/rating/{storeId}`
- 权限：所有用户
- 参数：
  - `storeId`：店铺ID，路径参数

#### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 4.8
}
```

#### 测试用例

- **用例1**：获取有客服评分的店铺
  - 请求：`GET /api/customer-service/rating/1`
  - 预期结果：返回该店铺的客服满意度评分

- **用例2**：获取无客服评分的店铺
  - 请求：`GET /api/customer-service/rating/3`（假设店铺3无评分）
  - 预期结果：返回0或null

- **用例3**：获取不存在的店铺
  - 请求：`GET /api/customer-service/rating/999`
  - 预期结果：返回错误信息，提示店铺不存在

### 12. 获取客服满意度统计（管理员功能）

#### 请求

- 方法：`GET`
- URL：`http://localhost:8080/api/customer-service/rating/stats`
- 权限：仅管理员

#### 响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "storeId": 1,
      "storeName": "电子产品商店",
      "averageRating": 4.8,
      "sessionCount": 120,
      "responseTime": 45
    },
    {
      "storeId": 2,
      "storeName": "服装专卖店",
      "averageRating": 4.6,
      "sessionCount": 85,
      "responseTime": 60
    }
  ]
}
```

#### 测试用例

- **用例1**：管理员获取客服满意度统计
  - 请求：`GET /api/customer-service/rating/stats`
  - 预期结果：返回所有店铺的客服满意度统计

- **用例2**：非管理员获取客服满意度统计
  - 请求：`GET /api/customer-service/rating/stats`（使用普通用户或商家token）
  - 预期结果：返回403错误，提示无权限

### 13. 处理客服投诉（管理员功能）

#### 请求

- 方法：`POST`
- URL：`http://localhost:8080/api/customer-service/complaints/{sessionId}`
- 权限：仅管理员
- 参数：
  - `sessionId`：会话ID，路径参数
- 请求体：

```json
{
  "status": 1,
  "result": "经核实，商家存在服务态度不佳的问题，已对其进行警告",
  "isPenalty": true,
  "penaltyContent": "扣除信用积分10分"
}
```

#### 响应

```json
{
  "code": 200,
  "msg": "投诉处理成功",
  "data": true
}
```

#### 测试用例

- **用例1**：处理投诉并处罚商家
  - 请求：`POST /api/customer-service/complaints/1`
    ```json
    {
      "status": 1,
      "result": "经核实，商家存在服务态度不佳的问题，已对其进行警告",
      "isPenalty": true,
      "penaltyContent": "扣除信用积分10分"
    }
    ```
  - 预期结果：处理成功，返回true

- **用例2**：驳回投诉
  - 请求：`POST /api/customer-service/complaints/3`
    ```json
    {
      "status": 2,
      "result": "经核实，用户投诉内容与实际情况不符，驳回投诉",
      "isPenalty": false
    }
    ```
  - 预期结果：处理成功，返回true

- **用例3**：非管理员处理投诉
  - 请求：`POST /api/customer-service/complaints/1`（使用普通用户或商家token）
    ```json
    {
      "status": 1,
      "result": "处理结果",
      "isPenalty": false
    }
    ```
  - 预期结果：返回403错误，提示无权限

## 错误码说明

- 200: 操作成功
- 400: 请求参数错误
- 401: 未认证或token过期
- 403: 无权操作
- 404: 资源不存在
- 500: 服务器内部错误

## 测试环境

- 测试基础URL: `http://localhost:8080/api/customer-service`
- 管理员账号: admin/password
- 普通用户账号: user/password
- 商家账号: merchant/password
